{"fileType":"apogee app js workspace","version":"0.60","references":{"viewState":{"treeState":1,"lists":{"es module":{"treeState":0},"js link":{"treeState":0},"css link":{"treeState":0}}}},"code":{"model":{"fileType":"apogee model","version":0.3,"name":"OneDriveTokenFlow","children":{"main":{"name":"main","type":"apogee.Folder","children":{"oneDriveAppInfo":{"name":"oneDriveAppInfo","type":"apogee.JsonMember","updateData":{"data":{"authServiceUri":"https://login.microsoftonline.com/common/oauth2/v2.0/authorize","clientId":"d87a2f91-7064-41d0-85b2-3e0775068ac2","redirectUri":"http://localhost:8888/dev/OneDrive/oneDriveAuthCallback.html","scopes":"user.read files.read files.read.all sites.read.all"}}},"loginForm":{"name":"loginForm","type":"apogee.FunctionMember","updateData":{"argList":["admin"],"functionBody":"//create a external callback to receive the response\n__globals__.oneDriveAuthCallback = (childWindow) => {\n    if(childWindow) {\n        let callbackInfo = {};\n        callbackInfo.hash = childWindow.location.hash;\n        callbackInfo.search = childWindow.location.search;\n        admin.getCommandMessenger().dataCommand(\"oneDriveCallbackData\",callbackInfo);\n        childWindow.close();\n    }\n} \n\nlet onLogin = () => {\n    //should we verify requesting page is https/file/localhost?\n    let url = `https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=${oneDriveAppInfo.clientId}&redirect_uri=${oneDriveAppInfo.redirectUri}&scope=${oneDriveAppInfo.scopes}&response_type=token`;\n    utils.openPopup(url);\n}\n\nlet onLogout = () => {\n    //should we verify requesting page is https/file/localhost?\n    let url = `https://login.live.com/oauth20_logout.srf?client_id=${oneDriveAppInfo.clientId}&redirect_uri=${oneDriveAppInfo.redirectUri}`;\n    utils.openPopup(url);\n}\n\nreturn [\n    {\n        type: \"submit\",\n        onSubmit: onLogin,\n        onCancel: onLogout,\n        submitLabel: \"Login\",\n        cancelLabel: \"Logout\"\n    }    \n]","supplementalCode":""}},"baseUrl":{"name":"baseUrl","type":"apogee.JsonMember","updateData":{"data":"https://graph.microsoft.com/v1.0/me/"}},"driveResponse":{"name":"driveResponse","type":"apogee.JsonMember","updateData":{"argList":[],"functionBody":"let options = {\n    header: { \n        \"Authorization\": \"Bearer \" + token,\n        \"Accept\": \"application/json;odata.metadata=none\"\n    }\n};\n\n\nlet folderPathPart;\nif(folderPath === \"\") {\n    folderPathPart = \"\";\n}\nelse {\n    folderPathPart = \":\" + folderPath + \":\"; \n}\n\nlet requestUrl = driveBaseUrl + folderPathPart + \"?expand=children\";\nreturn apogeeutil.jsonRequest(requestUrl,options);"}},"folderPath":{"name":"folderPath","type":"apogee.JsonMember","updateData":{"data":"/test"}},"driveBaseUrl":{"name":"driveBaseUrl","type":"apogee.JsonMember","updateData":{"argList":[],"functionBody":"return baseUrl + \"drive/root\"","supplementalCode":""}},"parentInfo":{"name":"parentInfo","type":"apogee.JsonMember","updateData":{"argList":[],"functionBody":"let parentEntry;\nif(driveResponse.parentReference) {\n    let parentPath;\n    let parentName;\n    if(driveResponse.parentReference.path) {\n        parentPath = driveResponse.parentReference.path.substring(\"/drive/root:\".length);\n        if(parentPath === \"\") {\n            parentPath = \"\"\n            parentName = \"/\";\n        }\n        else {\n            parentName = driveResponse.parentReference.name;\n        }\n        \n        parentEntry = {\n           name: parentName,\n           path: parentPath,\n           type: \"folder\"\n        }\n    }\n}\n\nif(!parentEntry) parentEntry = null;\n\nreturn parentEntry;","supplementalCode":""}},"childEntries":{"name":"childEntries","type":"apogee.JsonMember","updateData":{"argList":[],"functionBody":"\nlet children = [];\n\nif(driveResponse.folder) {\n    driveResponse.children.forEach( childEntry => {\n        let outEntry = {};\n        outEntry.name = childEntry.name;\n        if(childEntry.file) {\n            outEntry.url = childEntry[\"@microsoft.graph.downloadUrl\"];\n            outEntry.type = childEntry.file.mimeType;\n        }\n        if(childEntry.folder) {\n            outEntry.path = folderPath + \"/\" + outEntry.name;\n            outEntry.type = \"folder\";\n        }\n        let label = outEntry.name + \" - \" + outEntry.type;\n        children.push([label,outEntry]);\n    });\n}\n\nreturn children;","supplementalCode":""}},"fileName":{"name":"fileName","type":"apogee.JsonMember","updateData":{"data":"test3.json"}},"fileContent":{"name":"fileContent","type":"apogee.JsonMember","updateData":{"data":[4,8,12]}},"openForm":{"name":"openForm","type":"apogee.FunctionMember","updateData":{"argList":["admin"],"functionBody":"\n\nlet onOpen = formValue => {\n    \n    let selected = formValue.selected;\n    \n    if(selected.type == \"folder\") {\n        admin.getCommandMessenger().dataCommand(\"folderPath\",selected.path);\n    }\n    else {\n        let contentPromise\n        if(selected.type == \"application/json\") {\n            contentPromise = apogeeutil.jsonRequest(selected.url);\n        }\n        else if(selected.type == \"text/plain\") {\n            contentPromise = apogeeutil.textRequest(selected.url);\n        }\n        else {\n            alert(\"Only files of type json or plain text can be opened\");\n            return;\n        }\n        \n        admin.getCommandMessenger().compoundDataCommand([[\"fileName\",selected.name],[\"fileContent\",contentPromise]]);\n    }\n}\n\nlet allEntries;\nif(parentInfo) {\n    parentEntry = [\"Parent Folder\",parentInfo];\n    allEntries = [parentEntry].concat(childEntries);\n}\nelse {\n    allEntries = childEntries;\n}\n\nreturn [ \n    {\n        type: \"heading\",\n        text: \"File Path: \" + folderPath,\n        key: \"filePath\"\n    },\n    {\n        type: \"dropdown\",\n        label: \"Children: \",\n        entries: allEntries,\n        key: \"selected\",\n    },\n    {\n        type: \"submit\",\n        onSubmit: onOpen,\n        submitLabel: \"Open Selected\"\n    }\n]","supplementalCode":""}},"oneDriveCallbackData":{"name":"oneDriveCallbackData","type":"apogee.JsonMember","updateData":{"data":{"hash":"#access_token=EwBoA8l6BAAU6k7%2bXVQzkGyMv7VHB/h4cHbJYRAAAaUkO/XVfEIV8p3kRTzDI1cRAeIkYp4YJ9q6sw1YFnUAK9mlRbAP2FiiptbDLMbeS3WhdJULCRMX5pLGRknBwW5I5zubTS00OnFFSKnGJD7ksiGba906NIqQpXJ6cNvgt3RI3p1qe6eABpWnE%2bMjV2gU7CG2R2aF2THHfQphz5vpGg1%2bKarUrzH6sv8QiL64WB2xHEN4iZsjW/bGfqf6f/IayWxc9JtIagpyLXMAiHPA%2bE9eIYgCK%2bja50fvtSOfMTNwkuReuQGjRj6GSWpprVXzngbJrzM7v8nppK/4q%2bi4/fjF0lsHN3yoIdQs6ApsuFf675ut21Qc7xLp0rI2r5sDZgAACAnpamqNlji/OAIfvaDAMQ/rikFHrtW9wnmRjRBbeYL2ZIpbW2qPYBUFsBdKNso/4ATHYz3CUHgkd5QgndFsHcRqQXQ3n6FskF9GH2YaseT/Am49WM6NiEO2tLqut7IKC8dIlLRNgAlyTuwWU%2bmTE28TZQOlg6Kb0pvRHc6z6URA68fmYN31p9niE5o2zmKW58nc28oC/InJ6muOPLNnWNdeqKbC%2bGxN2AQxBBAdbE3Kq%2b4lvzFsJdX1BANhof7hLVqkdccbXGc99xtZ2z3Tgtscz4Mep/PuguELDujS8/TBsadRxhj7Zk8UW0yQMj2gqqByqg6MEqtMbxKyOzcdvuJ87W0QDtHmwWyC7rOLffrH7ubrFEu1Owz1456cS0HH9jH%2bshApi/60mkLGtPCadeoS1decx8z%2beZuuebnwmOAClKGc1MK%2bowzd/ZQXdSFO12bBEXC9VEfd9KIyKgTQkTYFystwUGsVufQpMecZx5FM%2b/ZVPRsk1Ug7jmDfrmoYV1Pu%2bMh9MNi8WX33gpCywqqL6EKuGGF2fdHMF%2bxlTXGacPy/SkGo06%2bZDAP6RzRS5/tVXQOTf2YAhNU%2bx1gGFxNzmn8wKRt8FQRQp5JUcjOvVjLMJlp/GIU8p7q7GMm/z9/aQ7qPmk7m7HdtquKp%2bKeWkE6B53uCNV6BWTIGXcG76/hVjl7kMn1Ss6DMFRPrekjj0ytJzRyAAHAPtTkTKHMc4l6COt4s%2b23yRM0IzSxpA6g4ypg8aPL%2bRscWNGiX8yxIfAI%3d&token_type=bearer&expires_in=3600&scope=User.Read%20Files.Read%20Files.Read.All%20Files.ReadWrite.All","search":""}}},"authData":{"name":"authData","type":"apogee.JsonMember","updateData":{"argList":[],"functionBody":"if(oneDriveCallbackData.hash) {\n    let paramArray = oneDriveCallbackData.hash.substring(1).split(\"&\").map(entry => entry.split(\"=\"));\n    let data = {};\n    paramArray.forEach( pair => data[pair[0]] = decodeURIComponent(pair[1]))\n    return data;\n}\nelse {\n    return null;\n}","supplementalCode":""}},"token":{"name":"token","type":"apogee.JsonMember","updateData":{"argList":[],"functionBody":"if((authData)&&(authData.access_token)) return authData.access_token;\nelse return null;","supplementalCode":""}},"authDataUpdateTime":{"name":"authDataUpdateTime","type":"apogee.JsonMember","updateData":{"argList":[],"functionBody":"if((authData)&&(authData.expires_in)) {\n    let expiresInSeconds = parseInt(authData.expires_in);\n    let nowMs = Date.now();\n    let expireMs = nowMs + expiresInSeconds*1000;\n    return {\n        expireInt: expireMs,\n        expireString: (new Date(expireMs)).toLocaleString(),\n        loadString: (new Date(nowMs)).toLocaleString()\n    }\n}","supplementalCode":""}},"userInfo":{"name":"userInfo","type":"apogee.JsonMember","updateData":{"argList":[],"functionBody":"let options = {\n    header: { \n        \"Authorization\": \"Bearer \" + token,\n        \"Accept\": \"application/json;odata.metadata=none\"\n    }\n};\n\n\nlet requestUrl = \"https://graph.microsoft.com/v1.0/me\";\nreturn apogeeutil.jsonRequest(requestUrl,options);","supplementalCode":""}},"userDrives":{"name":"userDrives","type":"apogee.JsonMember","updateData":{"argList":[],"functionBody":"let options = {\n    header: { \n        \"Authorization\": \"Bearer \" + token,\n        \"Accept\": \"application/json;odata.metadata=none\"\n    }\n};\n\n\nlet requestUrl = \"https://graph.microsoft.com/v1.0/me/drives\";\nreturn apogeeutil.jsonRequest(requestUrl,options);","supplementalCode":""}}}},"utils":{"name":"utils","type":"apogee.Folder","children":{"openPopup":{"name":"openPopup","type":"apogee.FunctionMember","updateData":{"argList":["url"],"functionBody":"var width = 525,\r\n        height = 525,\r\n        screenX = window.screenX,\r\n        screenY = window.screenY,\r\n        outerWidth = window.outerWidth,\r\n        outerHeight = window.outerHeight;\r\n\r\nvar left = screenX + Math.max(outerWidth - width, 0) / 2;\r\nvar top = screenY + Math.max(outerHeight - height, 0) / 2;\r\n\r\nvar features = [\r\n                        \"width=\" + width,\r\n                        \"height=\" + height,\r\n                        \"top=\" + top,\r\n                        \"left=\" + left,\r\n                        \"status=no\",\r\n                        \"resizable=yes\",\r\n                        \"toolbar=no\",\r\n                        \"menubar=no\",\r\n                        \"scrollbars=yes\"];\r\nvar popup = window.open(url, \"oauth\", features.join(\",\"));\r\nif (!popup) {\r\n    alert(\"failed to pop up auth window\");\r\n}\r\n\r\npopup.focus();\r\n    \r\n//cludge close check\r\n    \r\n// var timer = setInterval(checkChild, 100);\r\n// let counter = 0;\r\n// const MAX_COUNTER = 200;\r\n\r\n// function checkChild() {\r\n//     counter++;\r\n//     if(counter > MAX_COUNTER) {\r\n//         console.log(\"Max interval reached, giving up\");\r\n//         clearInterval(timer);\r\n//         return;\r\n//     }\r\n    \r\n//     if (popup.closed) {\r\n//         console.log(\"Child window closed! \" + counter);   \r\n//         clearInterval(timer);\r\n//     }\r\n//     else {\r\n//         console.log(\"Child not yet closed! \" + counter)\r\n//     }\r\n// }","supplementalCode":""}}}}}},"components":{"main":{"type":"apogeeapp.PageComponent","data":{"doc":{"type":"doc","content":[{"type":"heading1","content":[{"type":"text","text":"One Drive Token Auth Test"}]},{"type":"paragraph","content":[{"type":"text","text":"This method requires a re-login every hour. There is also a method (\"code flow\") that allows you to request refresh tokens, but there are a few reasons I don't think I want that."}]},{"type":"paragraph","content":[{"type":"text","text":"The code on this page will just fail if the authentication lapses. I think I should turn the token request into a promise. For the time being I might have to poll the login window to see when it closes. That is kind of cludgy, but I am not sure of better options right now."}]},{"type":"heading2","content":[{"type":"text","text":"Authentication"}]},{"type":"paragraph","content":[{"type":"text","text":"Here I use the Microsoft OAuth sample file (a slight mod of it) to save the access token (in this case) as a cookie."}]},{"type":"paragraph","content":[{"type":"text","text":"I think I should be using the other access object. The token is for short lived cases. See OneDrive docs.)"}]},{"type":"paragraph","content":[{"type":"text","text":"I think I should reconsider how I do this. "}]},{"type":"apogeeComponent","attrs":{"name":"oneDriveAppInfo","id":0,"state":""}},{"type":"paragraph","content":[{"type":"text","text":"This cell creates a global function that will be called when a OneDrive request from an external window is returned."}]},{"type":"paragraph"},{"type":"paragraph"},{"type":"paragraph"},{"type":"apogeeComponent","attrs":{"name":"loginForm","id":0,"state":""}},{"type":"paragraph"},{"type":"apogeeComponent","attrs":{"name":"oneDriveCallbackData","id":0,"state":""}},{"type":"paragraph"},{"type":"apogeeComponent","attrs":{"name":"authData","id":0,"state":""}},{"type":"apogeeComponent","attrs":{"name":"authDataUpdateTime","id":0,"state":""}},{"type":"paragraph"},{"type":"apogeeComponent","attrs":{"name":"token","id":0,"state":""}},{"type":"paragraph"},{"type":"heading2","content":[{"type":"text","text":"One Drive Requests"}]},{"type":"paragraph","content":[{"type":"text","text":"Here I make a simple file browser."}]},{"type":"apogeeComponent","attrs":{"name":"baseUrl","id":0,"state":""}},{"type":"apogeeComponent","attrs":{"name":"driveBaseUrl","id":0,"state":""}},{"type":"paragraph"},{"type":"paragraph","content":[{"type":"text","text":"Here we give the folder path. The root folder has path \"\" (not \"/\"!)"}]},{"type":"paragraph"},{"type":"apogeeComponent","attrs":{"name":"folderPath","id":0,"state":""}},{"type":"paragraph","content":[{"type":"text","text":"We give the content for this folder"}]},{"type":"apogeeComponent","attrs":{"name":"driveResponse","id":0,"state":""}},{"type":"paragraph","content":[{"type":"text","text":"Here we parse the child info, to show in our \"open form\""}]},{"type":"apogeeComponent","attrs":{"name":"childEntries","id":0,"state":""}},{"type":"apogeeComponent","attrs":{"name":"parentInfo","id":0,"state":""}},{"type":"paragraph","content":[{"type":"text","text":"This form opens a child (uh, or parent). If it is a folder it loads the folder here. If it is a file it loads the file below."}]},{"type":"apogeeComponent","attrs":{"name":"openForm","id":0,"state":""}},{"type":"heading2","content":[{"type":"text","text":"Child File"}]},{"type":"paragraph","content":[{"type":"text","text":"Here I display the content of a child file."}]},{"type":"apogeeComponent","attrs":{"name":"fileName","id":0,"state":""}},{"type":"apogeeComponent","attrs":{"name":"fileContent","id":0,"state":""}},{"type":"heading2","content":[{"type":"text","text":"User Request"}]},{"type":"paragraph","content":[{"type":"text","text":"This is the user info. "}]},{"type":"apogeeComponent","attrs":{"name":"userInfo","id":0,"state":""}},{"type":"paragraph","content":[{"type":"text","text":"These are the drives owned by the user."}]},{"type":"apogeeComponent","attrs":{"name":"userDrives","id":0,"state":""}},{"type":"paragraph"},{"type":"paragraph"}]}},"children":{"oneDriveAppInfo":{"type":"apogeeapp.JsonCell","dataView":"Colorized","viewState":{"childDisplayState":{"views":{"Data":{"isViewActive":true,"height":280},"Formula":{"isViewActive":false},"Private":{"isViewActive":false}}}}},"loginForm":{"type":"apogeeapp.ActionFormCell","viewState":{"childDisplayState":{"views":{"Form":{"isViewActive":true},"Code":{"isViewActive":true,"height":7000},"Private":{"isViewActive":false,"height":7000}}}}},"baseUrl":{"type":"apogeeapp.JsonCell","dataView":"Colorized","viewState":{"childDisplayState":{"views":{"Data":{"isViewActive":true,"height":280},"Formula":{"isViewActive":false},"Private":{"isViewActive":false}}}}},"driveResponse":{"type":"apogeeapp.JsonCell","dataView":"Colorized","viewState":{"childDisplayState":{"views":{"Data":{"isViewActive":true,"height":280},"Formula":{"isViewActive":true,"height":7000},"Private":{"isViewActive":false}}}}},"folderPath":{"type":"apogeeapp.JsonCell","dataView":"Colorized","viewState":{"childDisplayState":{"views":{"Data":{"isViewActive":true,"height":280},"Formula":{"isViewActive":false},"Private":{"isViewActive":false}}}}},"driveBaseUrl":{"type":"apogeeapp.JsonCell","dataView":"Colorized","viewState":{"childDisplayState":{"views":{"Data":{"isViewActive":true,"height":280},"Formula":{"isViewActive":true,"height":7000},"Private":{"isViewActive":false}}}}},"parentInfo":{"type":"apogeeapp.JsonCell","dataView":"Colorized","viewState":{"childDisplayState":{"views":{"Data":{"isViewActive":false,"height":280},"Formula":{"isViewActive":false,"height":7000},"Private":{"isViewActive":false}}}}},"childEntries":{"type":"apogeeapp.JsonCell","dataView":"Colorized","viewState":{"childDisplayState":{"views":{"Data":{"height":280,"isViewActive":false},"Formula":{"height":7000,"isViewActive":false},"Private":{"isViewActive":false}}}}},"fileName":{"type":"apogeeapp.JsonCell","dataView":"Colorized","viewState":{"childDisplayState":{"views":{"Data":{"isViewActive":true,"height":280},"Formula":{"isViewActive":false},"Private":{"isViewActive":false}}}}},"fileContent":{"type":"apogeeapp.JsonCell","dataView":"Colorized","viewState":{"childDisplayState":{"views":{"Data":{"isViewActive":true,"height":280},"Formula":{"isViewActive":false,"height":7000},"Private":{"isViewActive":false}}}}},"openForm":{"type":"apogeeapp.ActionFormCell","viewState":{"childDisplayState":{"views":{"Form":{"isViewActive":true},"Code":{"isViewActive":true,"height":7000},"Private":{"isViewActive":false}}}}},"oneDriveCallbackData":{"type":"apogeeapp.JsonCell","dataView":"Colorized","viewState":{"childDisplayState":{"views":{"Data":{"isViewActive":true,"height":280},"Formula":{"isViewActive":false},"Private":{"isViewActive":false}}}}},"authData":{"type":"apogeeapp.JsonCell","dataView":"Colorized","viewState":{"childDisplayState":{"views":{"Data":{"isViewActive":true,"height":280},"Formula":{"isViewActive":false,"height":7000},"Private":{"isViewActive":false}}}}},"token":{"type":"apogeeapp.JsonCell","dataView":"Colorized","viewState":{"childDisplayState":{"views":{"Data":{"isViewActive":true,"height":280},"Formula":{"isViewActive":true,"height":7000},"Private":{"isViewActive":false}}}}},"authDataUpdateTime":{"type":"apogeeapp.JsonCell","dataView":"Colorized","viewState":{"childDisplayState":{"views":{"Data":{"isViewActive":true,"height":280},"Formula":{"height":7000,"isViewActive":false},"Private":{"isViewActive":false}}}}},"userInfo":{"type":"apogeeapp.JsonCell","dataView":"Colorized","viewState":{"childDisplayState":{"views":{"Data":{"isViewActive":true,"height":280},"Formula":{"isViewActive":true,"height":7000},"Private":{"isViewActive":false}}}}},"userDrives":{"type":"apogeeapp.JsonCell","dataView":"Colorized","viewState":{"childDisplayState":{"views":{"Data":{"isViewActive":true,"height":280},"Formula":{"isViewActive":true,"height":7000},"Private":{"isViewActive":false}}}}}},"viewState":{"childDisplayState":null,"treeState":1,"tabOpened":true,"tabShowing":true}},"utils":{"type":"apogeeapp.PageComponent","data":{"doc":{"type":"doc","content":[{"type":"heading1","content":[{"type":"text","text":"Utils"}]},{"type":"heading2","content":[{"type":"text","text":"Open Popup"}]},{"type":"paragraph","content":[{"type":"text","text":"This function opens a child window at the given URL. This is intended for OAuth sign in."}]},{"type":"apogeeComponent","attrs":{"name":"openPopup","id":0,"state":""}},{"type":"heading2"}]}},"children":{"openPopup":{"type":"apogeeapp.FunctionCell","viewState":{"childDisplayState":{"views":{"Code":{"isViewActive":true,"height":7000},"Private":{"isViewActive":false}}}}}},"viewState":{"childDisplayState":null,"treeState":1,"tabOpened":true}},"viewState":{"treeState":1}}},"viewState":{"treeState":1}}