{"fileType":"apogee app js workspace","version":"0.60","references":{"refEntries":[{"url":"http://localhost:8888/dev/OneDrive/oneDriveAuth.js","nickname":"One Drive Auth","entryType":"js link"}],"viewState":{"treeState":1,"lists":{"es module":{"treeState":0},"js link":{"treeState":1},"css link":{"treeState":0}}}},"code":{"model":{"fileType":"apogee model","version":0.3,"name":"OneDriveRequestSample","children":{"main":{"name":"main","type":"apogee.Folder","children":{"oneDriveAppInfo":{"name":"oneDriveAppInfo","type":"apogee.JsonMember","updateData":{"data":{"authServiceUri":"https://login.microsoftonline.com/common/oauth2/v2.0/authorize","clientId":"d87a2f91-7064-41d0-85b2-3e0775068ac2","redirectUri":"http://localhost:8888/dev/OneDrive/oneDriveAuthCallback.html","scopes":"user.read files.read files.read.all sites.read.all"}}},"loginForm":{"name":"loginForm","type":"apogee.FunctionMember","updateData":{"argList":["admin"],"functionBody":"let onSubmit = () => {\n    oneDriveAuth(oneDriveAppInfo);\n    // let url = \"https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=credentials.clientId&scope=credentials.scope&response_type=token&redirect_uri=credentials.redirectUri\"\n    // let acccessTokenPromise = apogeeutil.jsonRequest(url);\n    // admin.getCommandMessenger().dataCommand(\"accessToken\",accessTokenPromise)\n}\n\nlet onLogout = () => {\n    logoutOfAuth()\n}\n\nreturn [\n    {\n        type: \"submit\",\n        onSubmit: onSubmit,\n        onCancel: onLogout,\n        submitLabel: \"Login\",\n        cancelLabel: \"Logout\"\n    }    \n]","supplementalCode":""}},"baseUrl":{"name":"baseUrl","type":"apogee.JsonMember","updateData":{"data":"https://graph.microsoft.com/v1.0/me/"}},"token":{"name":"token","type":"apogee.JsonMember","updateData":{"data":"EwBoA8l6BAAU6k7+XVQzkGyMv7VHB/h4cHbJYRAAAZ1mfGEIfP9vxlu08LTJOHx31V/CvEkNGYmyMJJhZQO/rqDZJBtgxU0JQT339ZoaG1hsIfB3anMuO+ytjxH9vpNt8bMVkVsVwJ9pPa+eW9P3mGqDzPR1lLSidyqUburgXmlN5WUzq2YL6DZyoy5heYmVJ08cxAS7d0DnLWcJPP6CH1zWzwQPy6/LibUVs7nWeaLXPjldp1Am3EVV5L6tBpHujF+s9ScMLnD9rUuLoVxHHo27WLKVtXFspHgPwqylHLQBzKX1WpAnDHqtQ5pNKdWci05ThsCCIKJXAJkO2C/U2UdceE155zRaTcUCSJV5Px63n3k1VC6Y3NqxBxUuOAMDZgAACBnUeLniellmOALGDxdGyVy3a1I0Qp4T4pBh1mK8UM1bqnAXC1nxOVxzbUvVLrfD2etqS/SH2NubS4QwMee517CtHA64Mff30TmOuxheBUc/qsViyyG6AV3OUDpCbyKOzjLC4NUANX3XpEfzNMXkV0tnA56Mixy/3OHvUXbbww4+Bynst1n9WnxeCkpaD25dJVDUbHTksL9MtTaYt/LNMrEokyqcImRFvQqI8348aBZXTCSzT6VOqUqMl5tpwen2P/ZcjgRz0FBnuyiOzhbcFb63svOvie2RP1hOQhtL4Y2tWkEvgyQ03YGzrk3/MbBbi0DkSC4UtsFY8VecJ+4qfGbY5lVmwboFacLBN62oxDL37Y88h5EWGNr/e4nL+9Zd/aA/6znQTwX1V/i+fkcs1M2ZAczRTH7GCh4AG5KLwA/QyZtlGm0r01544K1rbA1LmBvoJ+1yDd4RiyfQ9aU27E2HjDT2YPgYmRVTqEVYK1i8E+2VVu/T0KQA9KO38AYbkKhlXKQhoMfw/++q/SY1Er14QSAI10BLwyRS3muaFvL/QkFhO3wjkRl5GMxhU0fKcm34qcNwfsFHNvx8MIIW7ksgQC6pmoM6F+ADcmavoNoC+fvkJgZlL1GeEbwQNrA8T0GVmX7N4aeG3r2/A5QruIg3Qg/3/dTbmGzWcrNEBRstka6x0C4folydMgCzzFUvpvt0GIqSGdPknDzqKsabpfFMLBPwLHUCAkkcBDSk7VUpwTnX/m8bCPOVbH50oshuVgkLfAI="}},"driveResponse":{"name":"driveResponse","type":"apogee.JsonMember","updateData":{"argList":[],"functionBody":"let options = {\n    header: { \n        \"Authorization\": \"Bearer \" + token,\n        \"Accept\": \"application/json;odata.metadata=none\"\n    }\n};\n\n\nlet folderPathPart;\nif(folderPath === \"\") {\n    folderPathPart = \"\";\n}\nelse {\n    folderPathPart = \":\" + folderPath + \":\"; \n}\n\nlet requestUrl = driveBaseUrl + folderPathPart + \"?expand=thumbnails,children(expand=thumbnails(select=large))\";\nreturn apogeeutil.jsonRequest(requestUrl,options);","supplementalCode":""}},"driveItemUrl":{"name":"driveItemUrl","type":"apogee.JsonMember","updateData":{"argList":[],"functionBody":"return baseUrl + \"/drive/items\";","supplementalCode":""}},"folderPath":{"name":"folderPath","type":"apogee.JsonMember","updateData":{"data":""}},"driveBaseUrl":{"name":"driveBaseUrl","type":"apogee.JsonMember","updateData":{"argList":[],"functionBody":"return baseUrl + \"drive/root\"","supplementalCode":""}},"parentInfo":{"name":"parentInfo","type":"apogee.JsonMember","updateData":{"argList":[],"functionBody":"let parentEntry;\nif(driveResponse.parentReference) {\n    let parentPath;\n    let parentName;\n    if(driveResponse.parentReference.path) {\n        parentPath = driveResponse.parentReference.path.substring(\"/drive/root:\".length);\n        if(parentPath === \"\") {\n            parentPath = \"\"\n            parentName = \"/\";\n        }\n        else {\n            parentName = driveResponse.parentReference.name;\n        }\n        \n        parentEntry = {\n           name: parentName,\n           path: parentPath,\n           type: \"folder\"\n        }\n    }\n}\n\nif(!parentEntry) parentEntry = null;\n\nreturn parentEntry;","supplementalCode":""}},"childEntries":{"name":"childEntries","type":"apogee.JsonMember","updateData":{"argList":[],"functionBody":"\nlet children = [];\n\nif(driveResponse.folder) {\n    driveResponse.children.forEach( childEntry => {\n        let outEntry = {};\n        outEntry.name = childEntry.name;\n        if(childEntry.file) {\n            outEntry.url = childEntry[\"@microsoft.graph.downloadUrl\"];\n            outEntry.type = childEntry.file.mimeType;\n        }\n        if(childEntry.folder) {\n            outEntry.path = folderPath + \"/\" + outEntry.name;\n            outEntry.type = \"folder\";\n        }\n        let label = outEntry.name + \" - \" + outEntry.type;\n        children.push([label,outEntry]);\n    });\n}\n\nreturn children;","supplementalCode":""}},"fileName":{"name":"fileName","type":"apogee.JsonMember","updateData":{"data":""}},"fileContent":{"name":"fileContent","type":"apogee.JsonMember","updateData":{"data":""}},"openForm":{"name":"openForm","type":"apogee.FunctionMember","updateData":{"argList":["admin"],"functionBody":"\n\nlet onOpen = formValue => {\n    \n    let selected = formValue.selected;\n    \n    if(selected.type == \"folder\") {\n        admin.getCommandMessenger().dataCommand(\"folderPath\",selected.path);\n    }\n    else {\n        let contentPromise\n        if(selected.type == \"application/json\") {\n            contentPromise = apogeeutil.jsonRequest(selected.url);\n        }\n        else if(selected.type == \"text/plain\") {\n            contentPromise = apogeeutil.textRequest(selected.url);\n        }\n        else {\n            alert(\"Only files of type json or plain text can be opened\");\n            return;\n        }\n        \n        admin.getCommandMessenger().compoundDataCommand([[\"fileName\",selected.name],[\"fileContent\",contentPromise]]);\n    }\n}\n\nlet allEntries;\nif(parentInfo) {\n    parentEntry = [\"Parent Folder\",parentInfo];\n    allEntries = [parentEntry].concat(childEntries);\n}\nelse {\n    allEntries = childEntries;\n}\n\nreturn [ \n    {\n        type: \"heading\",\n        text: \"File Path: \" + folderPath,\n        key: \"filePath\"\n    },\n    {\n        type: \"dropdown\",\n        label: \"Children: \",\n        entries: allEntries,\n        key: \"selected\",\n    },\n    {\n        type: \"submit\",\n        onSubmit: onOpen,\n        submitLabel: \"Open Selected\"\n    }\n]","supplementalCode":""}},"loadTokenForm":{"name":"loadTokenForm","type":"apogee.FunctionMember","updateData":{"argList":["admin"],"functionBody":"let onSubmit = () => {\n    let token = getOneDriveToken();\n    admin.getCommandMessenger().dataCommand(\"token\",token);\n}\n\nreturn [\n    {\n        type: \"submit\",\n        onSubmit: onSubmit,\n        submitLabel: \"Load Token\"\n    }    \n]","supplementalCode":""}}}}}},"components":{"main":{"type":"apogeeapp.PageComponent","data":{"doc":{"type":"doc","content":[{"type":"heading2","content":[{"type":"text","text":"Authentication"}]},{"type":"paragraph","content":[{"type":"text","text":"Here I use the Microsoft OAuth sample file (a slight mod of it) to save the access token (in this case) as a cookie."}]},{"type":"paragraph","content":[{"type":"text","text":"I think I should be using the other access object. The token is for short lived cases. See OneDrive docs.)"}]},{"type":"paragraph","content":[{"type":"text","text":"I think I should reconsider how I do this. "}]},{"type":"apogeeComponent","attrs":{"name":"oneDriveAppInfo","id":0,"state":""}},{"type":"paragraph"},{"type":"apogeeComponent","attrs":{"name":"loginForm","id":0,"state":""}},{"type":"paragraph","content":[{"type":"text","text":"Here I have to load the token from the cookie, for how I use it below."}]},{"type":"apogeeComponent","attrs":{"name":"loadTokenForm","id":0,"state":""}},{"type":"paragraph","content":[{"type":"text","text":"This is the token."}]},{"type":"apogeeComponent","attrs":{"name":"token","id":0,"state":""}},{"type":"paragraph"},{"type":"heading2","content":[{"type":"text","text":"One Drive Requests"}]},{"type":"paragraph","content":[{"type":"text","text":"Here I make a simple file browser."}]},{"type":"apogeeComponent","attrs":{"name":"baseUrl","id":0,"state":""}},{"type":"apogeeComponent","attrs":{"name":"driveBaseUrl","id":0,"state":""}},{"type":"apogeeComponent","attrs":{"name":"driveItemUrl","id":0,"state":""}},{"type":"paragraph"},{"type":"paragraph","content":[{"type":"text","text":"Here we give the folder path. The root folder has path \"\" (not \"/\"!)"}]},{"type":"paragraph"},{"type":"apogeeComponent","attrs":{"name":"folderPath","id":0,"state":""}},{"type":"paragraph","content":[{"type":"text","text":"We give the content for this folder"}]},{"type":"apogeeComponent","attrs":{"name":"driveResponse","id":0,"state":""}},{"type":"paragraph","content":[{"type":"text","text":"Here we parse the child info, to show in our \"open form\""}]},{"type":"apogeeComponent","attrs":{"name":"childEntries","id":0,"state":""}},{"type":"apogeeComponent","attrs":{"name":"parentInfo","id":0,"state":""}},{"type":"paragraph","content":[{"type":"text","text":"This form opens a child (uh, or parent). If it is a folder it loads the folder here. If it is a file it loads the file below."}]},{"type":"apogeeComponent","attrs":{"name":"openForm","id":0,"state":""}},{"type":"heading2","content":[{"type":"text","text":"Child File"}]},{"type":"paragraph","content":[{"type":"text","text":"Here I display the content of a child file."}]},{"type":"apogeeComponent","attrs":{"name":"fileName","id":0,"state":""}},{"type":"apogeeComponent","attrs":{"name":"fileContent","id":0,"state":""}},{"type":"paragraph"},{"type":"paragraph"},{"type":"paragraph"},{"type":"paragraph"}]}},"children":{"oneDriveAppInfo":{"type":"apogeeapp.JsonCell","dataView":"Colorized","viewState":{"childDisplayState":{"views":{"Data":{"isViewActive":true,"height":280},"Formula":{"isViewActive":false},"Private":{"isViewActive":false}}}}},"loginForm":{"type":"apogeeapp.ActionFormCell","viewState":{"childDisplayState":{"views":{"Form":{"isViewActive":true},"Code":{"isViewActive":false,"height":7000},"Private":{"isViewActive":false}}}}},"baseUrl":{"type":"apogeeapp.JsonCell","dataView":"Colorized","viewState":{"childDisplayState":{"views":{"Data":{"isViewActive":true,"height":280},"Formula":{"isViewActive":false},"Private":{"isViewActive":false}}}}},"token":{"type":"apogeeapp.JsonCell","dataView":"Text Data","viewState":{"childDisplayState":{"views":{"Data":{"isViewActive":true,"height":280},"Formula":{"isViewActive":false},"Private":{"isViewActive":false}}}}},"driveResponse":{"type":"apogeeapp.JsonCell","dataView":"Colorized","viewState":{"childDisplayState":{"views":{"Data":{"isViewActive":false,"height":280},"Formula":{"isViewActive":false,"height":7000},"Private":{"isViewActive":false}}}}},"driveItemUrl":{"type":"apogeeapp.JsonCell","dataView":"Colorized","viewState":{"childDisplayState":{"views":{"Data":{"isViewActive":true,"height":280},"Formula":{"height":7000,"isViewActive":false},"Private":{"isViewActive":false}}}}},"folderPath":{"type":"apogeeapp.JsonCell","dataView":"Colorized","viewState":{"childDisplayState":{"views":{"Data":{"isViewActive":true,"height":280},"Formula":{"isViewActive":false},"Private":{"isViewActive":false}}}}},"driveBaseUrl":{"type":"apogeeapp.JsonCell","dataView":"Colorized","viewState":{"childDisplayState":{"views":{"Data":{"isViewActive":true,"height":280},"Formula":{"isViewActive":true,"height":7000},"Private":{"isViewActive":false}}}}},"parentInfo":{"type":"apogeeapp.JsonCell","dataView":"Colorized","viewState":{"childDisplayState":{"views":{"Data":{"isViewActive":false,"height":280},"Formula":{"isViewActive":false,"height":7000},"Private":{"isViewActive":false}}}}},"childEntries":{"type":"apogeeapp.JsonCell","dataView":"Colorized","viewState":{"childDisplayState":{"views":{"Data":{"height":280,"isViewActive":false},"Formula":{"height":7000,"isViewActive":false},"Private":{"isViewActive":false}}}}},"fileName":{"type":"apogeeapp.JsonCell","dataView":"Colorized","viewState":{"childDisplayState":{"views":{"Data":{"isViewActive":true,"height":280},"Formula":{"isViewActive":false},"Private":{"isViewActive":false}}}}},"fileContent":{"type":"apogeeapp.JsonCell","dataView":"Colorized","viewState":{"childDisplayState":{"views":{"Data":{"isViewActive":true,"height":280},"Formula":{"isViewActive":false},"Private":{"isViewActive":false}}}}},"openForm":{"type":"apogeeapp.ActionFormCell","viewState":{"childDisplayState":{"views":{"Form":{"isViewActive":true},"Code":{"isViewActive":false,"height":7000},"Private":{"isViewActive":false}}}}},"loadTokenForm":{"type":"apogeeapp.ActionFormCell","viewState":{"childDisplayState":{"views":{"Form":{"isViewActive":true},"Code":{"isViewActive":false,"height":7000},"Private":{"isViewActive":false}}}}}},"viewState":{"childDisplayState":null,"treeState":1,"tabOpened":true,"tabShowing":true}},"viewState":{"treeState":1}}},"viewState":{"treeState":1}}