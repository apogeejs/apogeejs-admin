{"fileType":"apogee app js workspace","version":"1.0","references":{"viewState":{"treeState":1,"lists":{"apogee module":{"treeState":0},"es module":{"treeState":0},"js link":{"treeState":0},"css link":{"treeState":0}}}},"code":{"model":{"fileType":"apogee model","version":"1.0","name":"Workspace","children":{"modules":{"name":"modules","type":"apogee.Folder","children":{}},"initialization":{"name":"initialization","type":"apogee.Folder","children":{"globalStuff":{"name":"globalStuff","type":"apogee.DataMember","fields":{"argList":[],"functionBody":"//data.onInitModulesMsg;\n//data.onAppStatusMsg;\n","supplementalCode":""}},"initModuleData":{"name":"initModuleData","type":"apogee.DataMember","fields":{"data":{"platform":"es","repositories":["http://localhost:8888/apogeejs-admin/dev/moduleManager/moduleDataTest.json"]}}},"appStatusData":{"name":"appStatusData","type":"apogee.DataMember","fields":{"data":{"loaded":[{"name":"apogeejs-module-chartjs","moduleType":"apogee module","platform":"es","versionData":{"version":"4.0.0-p.2","url":"http://localhost:8888/apogeejs-module-chartjs/src/ChartJSComponentModule2.js","demoWorkspaces":[{"url":"http://localhost:8888/apogeejs-module-chartjs/chartDemoWorkspaceLocal.json"}],"webLink":"https://apogeejs.com"},"sourceData":{"name":"test repo"}},{"name":"multi-login-component","moduleType":"apogee module","platform":"es","versionData":{"version":"2.0.0-p.1","url":"http://localhost:8888/apogeejs-admin/dev/moduleCreator/multiComponent/MultiLoginComponentModule.js"},"sourceData":{"name":"test repo"}}]}}},"moduleDataArray":{"name":"moduleDataArray","type":"apogee.DataMember","fields":{"argList":[],"functionBody":"return Promise.all(initialization.initModuleData.repositories.map(url => apogeeutil.jsonRequest(url)));","supplementalCode":""}}}}}},"components":{"modules":{"type":"apogeeapp.PageComponent","fields":{"editorState":{"doc":{"type":"doc","content":[{"type":"heading1","content":[{"type":"text","text":"Modules"}]},{"type":"paragraph","content":[{"type":"text","text":"This page contains the loaded modules and their status."}]}]}}},"viewState":{"childDisplayState":null,"tabOpened":true}},"initialization":{"type":"apogeeapp.PageComponent","fields":{"editorState":{"doc":{"type":"doc","content":[{"type":"heading1","content":[{"type":"text","text":"KLUDGE - Remote Module Manager"}]},{"type":"paragraph","content":[{"type":"text","text":"We need a way to run some external (to model) code on startup. We mock this up by creating a custom component and create a global object just once."}]},{"type":"paragraph","content":[{"type":"text","text":"In the global object we put the "},{"type":"text","marks":[{"type":"italic"}],"text":"sendMessage"},{"type":"text","text":" function and add a "},{"type":"text","marks":[{"type":"italic"}],"text":"receiveMessag"},{"type":"text","text":"e function which we use as a message listener."}]},{"type":"paragraph","content":[{"type":"text","text":"In onLoad, we define some functions to pass data into the model, which we use to handle some messages sent from the remote app. (Alternatively, we could have loaded functions from the model that did this for us. Here we would do that by loading them from data. Externally, we would load them from the workspace/model."}]},{"type":"apogeeComponent","attrs":{"name":"globalStuff","id":0,"state":""}},{"type":"paragraph","content":[{"type":"text","text":"Here is where we pass data to init the modules and to set the app status."}]},{"type":"apogeeComponent","attrs":{"name":"initModuleData","id":0,"state":""}},{"type":"apogeeComponent","attrs":{"name":"appStatusData","id":0,"state":""}},{"type":"heading2","content":[{"type":"text","text":"Repository Data"}]},{"type":"paragraph","content":[{"type":"text","text":"This is the requested data from the repositories"}]},{"type":"apogeeComponent","attrs":{"name":"moduleDataArray","id":0,"state":""}},{"type":"paragraph"},{"type":"paragraph"}]}}},"children":{"globalStuff":{"type":"apogeeapp.CustomCell","fields":{"destroyOnInactive":false,"html":"<p>This is a dummy component to do some global stuff</p>\n<ul>\n    <li>get the calling window and other init info</li>\n    <li>On load, create functions to pass message data into the model</li>\n    <li>create a globals function to send messages</li>\n    <li>start the message listener loop</li>\n</ul>","css":"","uiCode":"class GeneratorClass {\n    constructor() {\n        //KLUDGE\n        if(!window.mmGlobals) {\n            this._initGlobals();\n        }\n    }\n    \n    onLoad(outputElement,admin) {\n        if(window.mmGlobals) {\n            if(!window.mmGlobals.msgHandlers) {\n                //start listener and send \"started\" msg \n                //if this is the first time to set the handlers.\n                window.addEventListener(\"message\",window.mmGlobals.receiveMessage);\n                console.log(\"Message listener started!\");\n                window.mmGlobals.sendMessage(\"opened\",{});\n                console.log(\"Started message sent!!\");\n            }\n            window.mmGlobals.msgHandlers = {\n                initModules: data => admin.getMessenger().dataUpdate(\"initModuleData\",data),\n                appStatus: data => admin.getMessenger().dataUpdate(\"appStatusData\",data),\n            };\n        }\n    }\n    \n    /** Alternatively we could have called model functions we loaded here. */\n    //setData(msgHandlers,outputElement,admin) {\n    //\n    //}\n    \n    //===============================\n    // Private Methods\n    //===============================\n    _initGlobals() {\n        let mmGlobals = {};\n        \n        //get the calling window\n        mmGlobals.callingWindow = window.opener;\n    \n        //lod the url params\n        var params = new URLSearchParams(window.location.search);\n    \n        mmGlobals.callingUrl = params.get(\"callingUrl\");\n        if(!mmGlobals.callingUrl) {\n            this._fatalError(\"CallingUrl not found in input.\");\n            return false;\n        }\n    \n        mmGlobals.windowId = params.get(\"windowId\");\n        if(!mmGlobals.windowId) {\n            this._fatalError(\"Window ID not found in input.\");\n            return false;\n        }\n    \n        mmGlobals.sendMessage = function(messageType,commandData) {\n            let messageData = {};\n            messageData.commandData = commandData;\n        \n            //this identifies the window sending the message\n            messageData.windowId = mmGlobals.windowId;\n        \n            if((mmGlobals.callingWindow)&&(mmGlobals.callingWindow.postMessage)) {\n                console.log(\"sending message: \" + messageType);\n                mmGlobals.callingWindow.postMessage({message: messageType, value: messageData},mmGlobals.callingUrl);\n            }\n        }   \n            \n        mmGlobals.receiveMessage = function(event) {\n            console.log(\"received message: \" + event.data.message);\n            switch(event.data.message) {\n                case \"initModules\": \n                    mmGlobals.msgHandlers.initModules(event.data.value);\n                    break;\n        \n                case \"appStatus\": \n                    mmGlobals.msgHandlers.appStatus(event.data.value);\n                    break;\n        \n                case \"appClosed\": \n                    window.close();\n                    break;\n            }\n        }\n        \n        window.mmGlobals = mmGlobals;\n    }\n    \n    /** Temporary fatal error handling */\n    _fatalError(msg) {\n        throw new Error(msg);\n    }\n}\n\nreturn new GeneratorClass();\n\n"},"viewState":{"childDisplayState":{"views":{"Info":{"isViewActive":false},"Display":{"isViewActive":false},"HTML":{"isViewActive":false,"height":7000},"CSS":{"isViewActive":false},"uiGenerator()":{"isViewActive":false,"height":7000},"Formula":{"isViewActive":false,"height":7000},"Private":{"isViewActive":false}}}}},"initModuleData":{"type":"apogeeapp.JsonCell","fields":{"dataView":"Colorized"},"viewState":{"childDisplayState":{"views":{"Info":{"isViewActive":false},"Data":{"isViewActive":true,"height":280},"Formula":{"isViewActive":false},"Private":{"isViewActive":false}}}}},"appStatusData":{"type":"apogeeapp.JsonCell","fields":{"dataView":"Colorized"},"viewState":{"childDisplayState":{"views":{"Info":{"isViewActive":false},"Data":{"isViewActive":true,"height":7000},"Formula":{"isViewActive":false},"Private":{"isViewActive":false}}}}},"moduleDataArray":{"type":"apogeeapp.JsonCell","fields":{"dataView":"Colorized"},"viewState":{"childDisplayState":{"views":{"Info":{"isViewActive":false},"Data":{"isViewActive":true,"height":280},"Formula":{"isViewActive":true,"height":7000},"Private":{"isViewActive":false}}}}}},"viewState":{"treeState":1,"tabOpened":true,"tabShowing":true}},"viewState":{"treeState":1}}},"viewState":{"treeState":1}}